<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>compl.ai - Your EU Compliance Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Poppins', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        'warm': {
                            50: '#FFF9F0',
                            100: '#FFF2E1',
                            200: '#FFE4C4',
                            300: '#FFD4A3',
                            400: '#FFC078',
                            500: '#FF9800',
                            600: '#F57F17',
                            700: '#E65100',
                            800: '#BF360C',
                            900: '#8D2F00'
                        },
                        'peach': {
                            50: '#FFF8F0',
                            100: '#FFCC80',
                            200: '#FFB74D',
                            300: '#FFA726',
                            400: '#FF9800',
                            500: '#FFAB91'
                        },
                        'dark': {
                            800: '#1a1a1a',
                            900: '#0f0f0f'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass-effect {
            backdrop-filter: blur(16px);
            background: rgba(255, 255, 255, 0.05);
        }
        
        .loading-dot {
            animation: bounce 1.4s ease-in-out infinite both;
        }
        
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .capability-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 204, 128, 0.15);
        }
    </style>
</head>
<body class="font-sans bg-dark-900 text-white">
    <!-- Top Banner -->
    <div class="bg-white py-8">
        <div class="max-w-4xl mx-auto text-center px-6">
            <h1 class="text-3xl lg:text-4xl font-bold text-dark-900 tracking-wide">
                compl.ai
            </h1>
            <p class="text-lg text-gray-700 mt-2 font-medium">
                Made for those who are seeking guidance with EU regulations
            </p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="border-b border-gray-700 sticky top-0 z-50 bg-dark-900/95 backdrop-blur-sm">
        <div class="max-w-7xl mx-auto px-6 sm:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-peach-100 rounded-lg flex items-center justify-center">
                        <span class="text-dark-900 font-bold text-lg">C</span>
                    </div>
                    <span class="font-bold text-xl text-white">compl.ai</span>
                </div>
                
                <div class="hidden md:flex items-center space-x-8">
                    <a href="#features" class="text-gray-300 hover:text-white transition-colors">Features</a>
                    <a href="#how-it-works" class="text-gray-300 hover:text-white transition-colors">How it Works</a>
                </div>
                
                <div id="navButtons" class="flex items-center space-x-3">
                    <button id="loginNavButton" onclick="showLoginModal()" class="bg-peach-100 hover:bg-peach-200 text-dark-900 px-6 py-2.5 rounded-lg font-bold transition-colors">
                        Login to Start Chatting
                    </button>
                    <button id="logoutNavButton" onclick="handleLogout()" class="hidden bg-gray-600 hover:bg-gray-700 text-white px-4 py-2.5 rounded-lg font-medium transition-colors">
                        Logout
                    </button>
                    <button id="chatNavButton" onclick="openMainChat()" class="hidden bg-peach-100 hover:bg-peach-200 text-dark-900 px-6 py-2.5 rounded-lg font-bold transition-colors">
                        Chat now
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="bg-dark-900 text-white py-16 lg:py-24">
        <div class="max-w-7xl mx-auto px-6 sm:px-8">
            <div class="grid lg:grid-cols-2 gap-12 items-center">
                <div class="space-y-6">
                    <div class="space-y-4">
                        <h1 class="text-4xl lg:text-5xl font-bold leading-tight text-white">
                            Professional EU Compliance
                            <span class="bg-gradient-to-r from-peach-100 to-warm-300 bg-clip-text text-transparent">
                                AI Assistant
                            </span>
                        </h1>
                        <p class="text-xl text-gray-300 leading-relaxed max-w-lg">
                            Get instant, accurate guidance on EU regulations. Navigate GDPR, CSRD, and compliance requirements with AI-powered expertise.
                        </p>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button onclick="openMainChat()" class="bg-peach-100 hover:bg-peach-200 text-dark-900 px-8 py-4 rounded-lg font-bold transition-colors">
                            Chat now
                        </button>
                    </div>
                    
                    <div class="flex items-center space-x-6 text-sm text-gray-400">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                            <span>GDPR Compliant</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                            <span>EU Focused</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                            <span>24/7 Available</span>
                        </div>
                    </div>
                </div>
                
                <div class="relative">
                    <div class="glass-effect rounded-2xl p-6 border border-gray-600">
                        <div class="space-y-4">
                            <div class="flex items-center space-x-3 pb-4 border-b border-gray-600">
                                <div class="w-3 h-3 bg-red-400 rounded-full"></div>
                                <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
                                <div class="w-3 h-3 bg-green-400 rounded-full"></div>
                                <span class="text-sm text-gray-300 ml-4">compl.ai Assistant</span>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="flex justify-end">
                                    <div class="bg-peach-100 text-dark-900 px-4 py-2 rounded-2xl rounded-br-md max-w-xs text-sm font-medium">
                                        What are the key GDPR requirements for data processing?
                                    </div>
                                </div>
                                
                                <div class="flex justify-start">
                                    <div class="bg-gray-800 text-white px-4 py-3 rounded-2xl rounded-bl-md max-w-sm border border-gray-600">
                                        <p class="text-sm">Under GDPR, key requirements include:</p>
                                        <ul class="text-xs mt-2 space-y-1 text-gray-300">
                                            <li>â€¢ Lawful basis for processing</li>
                                            <li>â€¢ Data subject consent</li>
                                            <li>â€¢ Privacy by design</li>
                                            <li>â€¢ Impact assessments</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- How It Works -->
    <section id="how-it-works" class="py-20 bg-dark-800">
        <div class="max-w-7xl mx-auto px-6 sm:px-8">
            <div class="text-center mb-16">
                <h2 class="text-3xl lg:text-4xl font-bold text-white mb-4">How It Works</h2>
                <p class="text-xl text-gray-300 max-w-2xl mx-auto">Simple, secure EU compliance guidance in three steps</p>
            </div>
            
            <div class="grid md:grid-cols-3 gap-8">
                <div class="text-center space-y-4">
                    <div class="w-16 h-16 bg-peach-100 rounded-full flex items-center justify-center mx-auto">
                        <span class="text-2xl font-bold text-dark-900">1</span>
                    </div>
                    <h3 class="text-xl font-semibold text-white">Ask Your Question</h3>
                    <p class="text-gray-300">Ask about GDPR, CSRD, or any EU regulation in natural language. Our AI understands complex compliance terminology.</p>
                </div>
                
                <div class="text-center space-y-4">
                    <div class="w-16 h-16 bg-peach-100 rounded-full flex items-center justify-center mx-auto">
                        <span class="text-2xl font-bold text-dark-900">2</span>
                    </div>
                    <h3 class="text-xl font-semibold text-white">AI Analysis</h3>
                    <p class="text-gray-300">Advanced AI analyzes your query against comprehensive EU regulatory knowledge with proper citations.</p>
                </div>
                
                <div class="text-center space-y-4">
                    <div class="w-16 h-16 bg-peach-100 rounded-full flex items-center justify-center mx-auto">
                        <span class="text-2xl font-bold text-dark-900">3</span>
                    </div>
                    <h3 class="text-xl font-semibold text-white">Get Expert Guidance</h3>
                    <p class="text-gray-300">Receive detailed, accurate responses with relevant regulatory references and compliance recommendations.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Features -->
    <section id="features" class="py-20 bg-dark-900">
        <div class="max-w-7xl mx-auto px-6 sm:px-8">
            <div class="text-center mb-16">
                <h2 class="text-3xl lg:text-4xl font-bold text-white mb-4">Powerful Features</h2>
                <p class="text-xl text-gray-300 max-w-2xl mx-auto">Everything you need for EU compliance guidance</p>
            </div>
            
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-600 hover:border-peach-100 transition-all">
                    <div class="w-12 h-12 bg-peach-100 rounded-lg flex items-center justify-center mb-4">
                        <svg class="w-6 h-6 text-dark-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-2">GDPR Expertise</h3>
                    <p class="text-gray-300 text-sm">Comprehensive guidance on data protection, privacy rights, and GDPR compliance requirements.</p>
                </div>
                
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-600 hover:border-peach-100 transition-all">
                    <div class="w-12 h-12 bg-peach-100 rounded-lg flex items-center justify-center mb-4">
                        <svg class="w-6 h-6 text-dark-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-2">Secure & Confidential</h3>
                    <p class="text-gray-300 text-sm">Enterprise-grade security ensures your compliance consultations remain completely confidential.</p>
                </div>
                
                <div class="bg-gray-800 p-6 rounded-xl border border-gray-600 hover:border-peach-100 transition-all">
                    <div class="w-12 h-12 bg-peach-100 rounded-lg flex items-center justify-center mb-4">
                        <svg class="w-6 h-6 text-dark-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9" />
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-white mb-2">EU Regulations</h3>
                    <p class="text-gray-300 text-sm">Specialized knowledge of CSRD, EU Taxonomy, Digital Services Act, and other key regulations.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Chat Interface - Hidden by default -->
    <div id="mainChatContainer" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-dark-900 rounded-2xl w-full max-w-7xl h-[90vh] flex overflow-hidden shadow-2xl border border-gray-600">
            <!-- Sidebar -->
            <div class="w-80 bg-gray-800 border-r border-gray-600 flex flex-col">
                <div class="p-6 border-b border-gray-600">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-peach-100 rounded-lg flex items-center justify-center">
                                <span class="text-dark-900 font-bold text-lg">C</span>
                            </div>
                            <h1 class="font-bold text-xl text-white">compl.ai</h1>
                        </div>
                        <button onclick="closeMainChat()" class="text-gray-400 hover:text-white p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                    
                    <div class="text-sm">
                        <div id="authStatus" class="flex items-center space-x-2 text-red-400">
                            <div class="w-2 h-2 bg-current rounded-full"></div>
                            <span>Not connected</span>
                        </div>
                        <button id="sidebarLogoutButton" onclick="handleLogout()" class="hidden mt-2 text-xs text-gray-400 hover:text-white transition-colors">
                            Logout
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-6 space-y-6">
                    <div class="bg-gray-700 rounded-xl p-6 border border-gray-600">
                        <h2 class="font-semibold text-white mb-4">EU Compliance Assistant</h2>
                        <p class="text-sm text-gray-300 mb-4">
                            Professional guidance on EU regulations, GDPR compliance, and regulatory requirements.
                        </p>
                    </div>

                    <div class="bg-gray-700 rounded-xl p-6 border border-gray-600">
                        <h3 class="font-semibold text-white mb-4">Expertise Areas</h3>
                        <div class="space-y-3">
                            <div class="capability-item p-3 bg-gray-600 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-500" onclick="sendSampleQuery('What are the key GDPR compliance requirements for data processing?')">
                                <div class="flex items-start space-x-3">
                                    <div class="w-6 h-6 bg-peach-100 rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <span class="text-xs text-dark-900">ðŸ”’</span>
                                    </div>
                                    <div>
                                        <div class="font-medium text-sm text-white">GDPR Compliance</div>
                                        <div class="text-xs text-gray-300">Data protection and privacy regulations</div>
                                    </div>
                                </div>
                            </div>

                            <div class="capability-item p-3 bg-gray-600 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-500" onclick="sendSampleQuery('What are CSRD reporting requirements for sustainability?')">
                                <div class="flex items-start space-x-3">
                                    <div class="w-6 h-6 bg-peach-100 rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <span class="text-xs text-dark-900">ðŸŒ±</span>
                                    </div>
                                    <div>
                                        <div class="font-medium text-sm text-white">CSRD Reporting</div>
                                        <div class="text-xs text-gray-300">Sustainability disclosure requirements</div>
                                    </div>
                                </div>
                            </div>

                            <div class="capability-item p-3 bg-gray-600 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-500" onclick="sendSampleQuery('What are the EU Taxonomy compliance requirements?')">
                                <div class="flex items-start space-x-3">
                                    <div class="w-6 h-6 bg-peach-100 rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <span class="text-xs text-dark-900">ðŸ“Š</span>
                                    </div>
                                    <div>
                                        <div class="font-medium text-sm text-white">EU Taxonomy</div>
                                        <div class="text-xs text-gray-300">Sustainable finance classifications</div>
                                    </div>
                                </div>
                            </div>

                            <div class="capability-item p-3 bg-gray-600 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-500" onclick="sendSampleQuery('What are Digital Services Act obligations for platforms?')">
                                <div class="flex items-start space-x-3">
                                    <div class="w-6 h-6 bg-peach-100 rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                                        <span class="text-xs text-dark-900">ðŸ’»</span>
                                    </div>
                                    <div>
                                        <div class="font-medium text-sm text-white">Digital Services Act</div>
                                        <div class="text-xs text-gray-300">Platform compliance obligations</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="flex-1 flex flex-col bg-dark-900">
                <div class="p-6 border-b border-gray-600">
                    <h2 class="font-semibold text-xl text-white">compl.ai Assistant</h2>
                    <p class="text-sm text-gray-400 mt-1">EU compliance guidance at your fingertips</p>
                    <div id="sessionInfo" class="text-xs text-gray-500 mt-1"></div>
                </div>

                <div id="chatMessages" class="flex-1 overflow-y-auto p-6 bg-gray-800 space-y-4">
                    <div class="flex justify-start">
                        <div class="bg-gray-700 text-white px-6 py-4 rounded-2xl rounded-bl-md max-w-2xl border border-gray-600 shadow-sm">
                            <p class="mb-2">Hello! I'm your compl.ai Assistant. I specialize in EU regulations, GDPR compliance, CSRD reporting, and regulatory requirements.</p>
                            <p class="mb-2">I can help you navigate complex compliance questions with detailed guidance backed by regulatory sources.</p>
                            <p class="font-medium">How can I assist you with EU compliance today?</p>
                        </div>
                    </div>
                </div>

                <div class="p-6 bg-gray-800 border-t border-gray-600">
                    <form id="chatForm" class="flex space-x-4">
                        <div class="flex-1">
                            <textarea 
                                id="messageInput"
                                placeholder="Ask your EU compliance question here... (Press Ctrl+Enter to send)"
                                class="w-full px-4 py-3 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-peach-100 focus:border-peach-100 resize-none bg-gray-700 text-white placeholder-gray-400"
                                rows="1"
                                disabled
                            ></textarea>
                        </div>
                        <button 
                            type="submit" 
                            id="sendButton"
                            class="bg-peach-100 hover:bg-peach-200 text-dark-900 px-6 py-3 rounded-lg font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed min-w-[80px]"
                            disabled
                        >
                            Send
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginContainer" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl p-8 w-full max-w-md shadow-2xl border border-gray-600">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-peach-100 rounded-lg flex items-center justify-center mx-auto mb-4">
                    <span class="text-dark-900 font-bold text-2xl">C</span>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2">Welcome to compl.ai</h3>
                <p class="text-gray-300">Please log in to access EU compliance assistance</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <input 
                        type="text" 
                        id="username" 
                        placeholder="Username (try: admin)"
                        class="w-full px-4 py-3 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-peach-100 focus:border-peach-100 bg-gray-700 text-white placeholder-gray-400"
                        required
                    >
                </div>
                <div>
                    <input 
                        type="password" 
                        id="password" 
                        placeholder="Password (try: admin123)"
                        class="w-full px-4 py-3 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-peach-100 focus:border-peach-100 bg-gray-700 text-white placeholder-gray-400"
                        required
                    >
                </div>
                <button 
                    type="submit" 
                    class="w-full bg-peach-100 hover:bg-peach-200 text-dark-900 py-3 rounded-lg font-bold transition-colors"
                >
                    Log In
                </button>
                <div id="loginError" class="hidden text-red-400 text-sm text-center p-3 bg-red-900/30 rounded-lg border border-red-800"></div>
            </form>
        </div>
    </div>

    <!-- CONFIG -->
    <script>
        const CONFIG = {
            API_BASE: 'http://localhost:8000',
            ENDPOINTS: {
                LOGIN: '/auth/login',      
                ME: '/auth/me',           
                CHAT: '/v1/chat',
                SEARCH: '/v1/search',
                CHAT_HISTORY: '/v1/chat/history',
                CLEAR_SESSION: '/v1/chat/session',
                USER_SESSIONS: '/v1/chat/sessions'
            },
            STORAGE_KEYS: {
                AUTH_TOKEN: 'legal_ai_token',
                USER_DATA: 'legal_ai_user',
                CURRENT_SESSION: 'current_session_id'
            },
            UI: {
                MAX_MESSAGE_LENGTH: 5000,
                TEXTAREA_MAX_HEIGHT: 120,
                AUTO_SCROLL_THRESHOLD: 100
            }
        };
    </script>

    <!-- API CLIENT -->
    <script>
        class APIClient {
            constructor() {
                this.baseURL = CONFIG.API_BASE;
                this.token = localStorage.getItem(CONFIG.STORAGE_KEYS.AUTH_TOKEN);
                this.currentSessionId = localStorage.getItem(CONFIG.STORAGE_KEYS.CURRENT_SESSION);
            }

            setToken(token) {
                this.token = token;
                if (token) {
                    localStorage.setItem(CONFIG.STORAGE_KEYS.AUTH_TOKEN, token);
                } else {
                    localStorage.removeItem(CONFIG.STORAGE_KEYS.AUTH_TOKEN);
                }
            }

            setCurrentSession(sessionId) {
                this.currentSessionId = sessionId;
                if (sessionId) {
                    localStorage.setItem(CONFIG.STORAGE_KEYS.CURRENT_SESSION, sessionId);
                    console.log('Session stored:', sessionId);
                } else {
                    localStorage.removeItem(CONFIG.STORAGE_KEYS.CURRENT_SESSION);
                    console.log('Session cleared');
                }
            }

            getCurrentSession() {
                return this.currentSessionId;
            }

            getAuthHeaders() {
                return {
                    'Content-Type': 'application/json',
                    ...(this.token && { 'Authorization': `Bearer ${this.token}` })
                };
            }

            async makeRequest(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                const config = {
                    headers: this.getAuthHeaders(),
                    ...options
                };

                try {
                    const response = await fetch(url, config);
                    const data = await response.json().catch(() => ({}));

                    if (!response.ok) {
                        throw new APIError(response.status, data.detail || 'Request failed', data);
                    }

                    return { data, status: response.status };
                } catch (error) {
                    if (error instanceof APIError) throw error;
                    throw new APIError(0, 'Network error', { originalError: error.message });
                }
            }

            async login(username, password) {
                const response = await this.makeRequest(CONFIG.ENDPOINTS.LOGIN, {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
                return response.data;
            }

            async getCurrentUser() {
                const response = await this.makeRequest(CONFIG.ENDPOINTS.ME);
                return response.data;
            }

            async sendMessage(message) {
                // Build URL with session_id parameter if we have one
                let endpoint = CONFIG.ENDPOINTS.CHAT;
                if (this.currentSessionId) {
                    endpoint += `?session_id=${encodeURIComponent(this.currentSessionId)}`;
                    console.log('Sending message with session:', this.currentSessionId);
                } else {
                    console.log('Sending message without session (will create new)');
                }

                const response = await this.makeRequest(endpoint, {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: 'user',
                        query: message
                    })
                });

                // Store session_id from response for future requests
                if (response.data.session_id) {
                    this.setCurrentSession(response.data.session_id);
                    console.log('Updated session ID to:', response.data.session_id);
                }

                return response.data;
            }

            // FIXED streaming message method
            async sendMessageStream(message, onChunk, onComplete, onError) {
                // Build URL with proper query parameters
                let endpoint = CONFIG.ENDPOINTS.CHAT;
                let params = new URLSearchParams();
                params.append('stream', 'true');
                
                if (this.currentSessionId) {
                    params.append('session_id', this.currentSessionId);
                    console.log('Sending streaming message with session:', this.currentSessionId);
                } else {
                    console.log('Sending streaming message without session (will create new)');
                }
                
                endpoint += `?${params.toString()}`;

                try {
                    const response = await fetch(`${this.baseURL}${endpoint}`, {
                        method: 'POST',
                        headers: this.getAuthHeaders(),
                        body: JSON.stringify({
                            user_id: 'user',
                            query: message
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new APIError(response.status, errorData.detail || 'Streaming request failed');
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // Keep incomplete line in buffer

                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                try {
                                    const data = JSON.parse(line.slice(6));
                                    
                                    console.log('Received streaming data:', data.type, data.content?.substring(0, 50));
                                    
                                    if (data.type === 'chunk') {
                                        onChunk(data.content, data.session_id);
                                    } else if (data.type === 'complete') {
                                        if (data.session_id) {
                                            this.setCurrentSession(data.session_id);
                                        }
                                        onComplete(data.content, data.session_id);
                                        return;
                                    } else if (data.type === 'error') {
                                        onError(new Error(data.content));
                                        return;
                                    }
                                } catch (e) {
                                    console.warn('Failed to parse streaming data:', line, e);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Streaming error:', error);
                    onError(error);
                }
            }

            async getChatHistory(sessionId) {
                const response = await this.makeRequest(`${CONFIG.ENDPOINTS.CHAT_HISTORY}/${sessionId}`);
                return response.data;
            }

            async clearSession(sessionId) {
                const response = await this.makeRequest(`${CONFIG.ENDPOINTS.CLEAR_SESSION}/${sessionId}`, {
                    method: 'DELETE'
                });
                return response.data;
            }

            async getUserSessions() {
                const response = await this.makeRequest(CONFIG.ENDPOINTS.USER_SESSIONS);
                return response.data;
            }
        }

        class APIError extends Error {
            constructor(status, message, data = {}) {
                super(message);
                this.name = 'APIError';
                this.status = status;
                this.data = data;
            }

            isAuthError() {
                return this.status === 401;
            }

            isServerError() {
                return this.status >= 500;
            }

            isClientError() {
                return this.status >= 400 && this.status < 500;
            }
        }
    </script>

    <!-- AUTH MANAGER -->
    <script>
        class AuthManager {
            constructor(apiClient) {
                this.api = apiClient;
                this.currentUser = null;
                this.isAuthenticated = false;
                this.onAuthChange = [];
            }

            addAuthChangeListener(callback) {
                this.onAuthChange.push(callback);
            }

            removeAuthChangeListener(callback) {
                this.onAuthChange = this.onAuthChange.filter(cb => cb !== callback);
            }

            notifyAuthChange(isAuthenticated, user = null) {
                this.isAuthenticated = isAuthenticated;
                this.currentUser = user;
                this.onAuthChange.forEach(callback => callback(isAuthenticated, user));
            }

            async login(username, password) {
                try {
                    const result = await this.api.login(username, password);
                    this.api.setToken(result.access_token);
                    
                    const user = await this.api.getCurrentUser();
                    localStorage.setItem(CONFIG.STORAGE_KEYS.USER_DATA, JSON.stringify(user));
                    
                    this.notifyAuthChange(true, user);
                    return { success: true, user };
                } catch (error) {
                    console.error('Login failed:', error);
                    return { success: false, error: error.message };
                }
            }

            async checkAuthentication() {
                const token = localStorage.getItem(CONFIG.STORAGE_KEYS.AUTH_TOKEN);
                
                if (!token) {
                    this.notifyAuthChange(false);
                    return false;
                }

                try {
                    const user = await this.api.getCurrentUser();
                    this.notifyAuthChange(true, user);
                    return true;
                } catch (error) {
                    if (error.isAuthError()) {
                        this.logout();
                    }
                    return false;
                }
            }

            logout() {
                this.api.setToken(null);
                this.api.setCurrentSession(null); // Clear session on logout
                localStorage.removeItem(CONFIG.STORAGE_KEYS.USER_DATA);
                this.notifyAuthChange(false);
            }

            getCurrentUser() {
                return this.currentUser;
            }

            isLoggedIn() {
                return this.isAuthenticated;
            }
        }
    </script>

    <!-- UI MANAGER -->
    <script>
        class UIManager {
            constructor() {
                this.elements = {};
                this.initializeElements();
                this.setupEventListeners();
            }

            initializeElements() {
                this.elements = {
                    chatMessages: document.getElementById('chatMessages'),
                    messageInput: document.getElementById('messageInput'),
                    sendButton: document.getElementById('sendButton'),
                    chatForm: document.getElementById('chatForm'),
                    loginContainer: document.getElementById('loginContainer'),
                    loginForm: document.getElementById('loginForm'),
                    authStatus: document.getElementById('authStatus'),
                    loginError: document.getElementById('loginError'),
                    usernameInput: document.getElementById('username'),
                    passwordInput: document.getElementById('password'),
                    sessionInfo: document.getElementById('sessionInfo')
                };
            }

            setupEventListeners() {
                this.elements.messageInput.addEventListener('input', () => this.autoResizeTextarea());
                this.elements.messageInput.addEventListener('keydown', (e) => this.handleKeyboardShortcuts(e));
            }

            autoResizeTextarea() {
                const textarea = this.elements.messageInput;
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, CONFIG.UI.TEXTAREA_MAX_HEIGHT) + 'px';
            }

            handleKeyboardShortcuts(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    e.preventDefault();
                    this.elements.chatForm.dispatchEvent(new Event('submit'));
                }
            }

            showLogin() {
                this.elements.loginContainer.classList.remove('hidden');
                this.elements.usernameInput.focus();
            }

            hideLogin() {
                this.elements.loginContainer.classList.add('hidden');
                this.hideLoginError();
                this.clearLoginForm();
            }

            showLoginError(message) {
                this.elements.loginError.textContent = message;
                this.elements.loginError.classList.remove('hidden');
            }

            hideLoginError() {
                this.elements.loginError.classList.add('hidden');
            }

            clearLoginForm() {
                this.elements.usernameInput.value = '';
                this.elements.passwordInput.value = '';
            }

            updateAuthStatus(isConnected, username = null) {
                const statusElement = this.elements.authStatus;
                const loginNavButton = document.getElementById('loginNavButton');
                const logoutNavButton = document.getElementById('logoutNavButton');
                const chatNavButton = document.getElementById('chatNavButton');
                const sidebarLogoutButton = document.getElementById('sidebarLogoutButton');
                
                if (isConnected) {
                    statusElement.className = 'flex items-center space-x-2 text-green-400';
                    statusElement.innerHTML = `
                        <div class="w-2 h-2 bg-current rounded-full"></div>
                        <span>Connected${username ? ' as ' + username : ''}</span>
                    `;
                    
                    // Update navigation buttons
                    if (loginNavButton) loginNavButton.classList.add('hidden');
                    if (logoutNavButton) logoutNavButton.classList.remove('hidden');
                    if (chatNavButton) chatNavButton.classList.remove('hidden');
                    if (sidebarLogoutButton) sidebarLogoutButton.classList.remove('hidden');
                    
                    // Enable chat input
                    this.elements.messageInput.disabled = false;
                    this.elements.messageInput.placeholder = 'Ask your EU compliance question here... (Press Ctrl+Enter to send)';
                    this.elements.sendButton.disabled = false;
                } else {
                    statusElement.className = 'flex items-center space-x-2 text-red-400';
                    statusElement.innerHTML = `
                        <div class="w-2 h-2 bg-current rounded-full"></div>
                        <span>Not connected</span>
                    `;
                    
                    // Update navigation buttons
                    if (loginNavButton) loginNavButton.classList.remove('hidden');
                    if (logoutNavButton) logoutNavButton.classList.add('hidden');
                    if (chatNavButton) chatNavButton.classList.add('hidden');
                    if (sidebarLogoutButton) sidebarLogoutButton.classList.add('hidden');
                    
                    // Disable chat input
                    this.elements.messageInput.disabled = true;
                    this.elements.messageInput.placeholder = 'Please log in first...';
                    this.elements.sendButton.disabled = true;
                }
            }

            updateSessionInfo(sessionId, messageCount = 0) {
                if (this.elements.sessionInfo) {
                    if (sessionId && sessionId !== 'new') {
                        this.elements.sessionInfo.textContent = `Session: ${sessionId.substring(0, 8)}... | Messages: ${messageCount}`;
                    } else {
                        this.elements.sessionInfo.textContent = 'New conversation';
                    }
                }
            }

            clearMessageInput() {
                this.elements.messageInput.value = '';
                this.elements.messageInput.style.height = 'auto';
            }

            setSendButtonState(enabled, text = null) {
                this.elements.sendButton.disabled = !enabled;
                this.elements.sendButton.textContent = text || (enabled ? 'Send' : 'Sending...');
            }

            focusMessageInput() {
                this.elements.messageInput.focus();
            }

            scrollToBottom() {
                this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
            }

            addMessage(sender, content, citations = null, timestamp = null, sessionId = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex justify-${sender === 'user' ? 'end' : 'start'}`;

                const bubbleClass = sender === 'user' 
                    ? 'bg-peach-100 text-dark-900 px-6 py-4 rounded-2xl rounded-br-md max-w-2xl font-medium'
                    : 'bg-gray-700 text-white px-6 py-4 rounded-2xl rounded-bl-md max-w-2xl border border-gray-600 shadow-sm';

                let citationsHTML = '';
                if (citations && citations.length > 0) {
                    citationsHTML = `
                        <div class="mt-4 pt-4 border-t border-gray-600">
                            <div class="text-xs font-medium text-gray-400 mb-2">Sources:</div>
                            ${citations.map(citation => `
                                <div class="bg-gray-600 rounded-lg p-3 mb-2">
                                    <div class="text-xs font-medium text-peach-100 break-all">${this.sanitizeHTML(citation.source)}</div>
                                    <div class="text-xs text-gray-300 mt-1">${this.sanitizeHTML(citation.snippet)}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                // Add session info for assistant messages (optional)
                let sessionDebugInfo = '';
                if (sender === 'assistant' && sessionId) {
                    sessionDebugInfo = `<div class="text-xs text-gray-500 mt-2">Session: ${sessionId.substring(0, 8)}...</div>`;
                }

                messageDiv.innerHTML = `
                    <div class="${bubbleClass}">
                        <div class="text-sm">${this.formatMessageContent(content)}</div>
                        ${citationsHTML}
                        ${sessionDebugInfo}
                    </div>
                `;

                this.elements.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();

                // Update session info in header
                if (sessionId) {
                    this.updateSessionInfo(sessionId);
                }

                return messageDiv;
            }

            formatMessageContent(content) {
                return content
                    // Convert headers with proper spacing and styling
                    .replace(/^### (.+)$/gm, '<h3 class="text-lg font-bold text-white mt-6 mb-3 border-b border-gray-600 pb-2">$1</h3>')
                    .replace(/^## (.+)$/gm, '<h2 class="text-xl font-bold text-white mt-8 mb-4 border-b-2 border-peach-100 pb-2">$1</h2>')
                    .replace(/^# (.+)$/gm, '<h1 class="text-2xl font-bold text-white mt-8 mb-4">$1</h1>')
                    // Bold and italic
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-white">$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em class="italic">$1</em>')
                    // Code blocks
                    .replace(/`(.*?)`/g, '<code class="bg-gray-600 px-2 py-1 rounded text-xs font-mono">$1</code>')
                    // Convert bullet points
                    .replace(/^- (.+)$/gm, '<li class="ml-4 mb-1">â€¢ $1</li>')
                    .replace(/^â€¢ (.+)$/gm, '<li class="ml-4 mb-1">â€¢ $1</li>')
                    // Paragraphs with proper spacing
                    .replace(/\n\n/g, '</p><p class="mb-4">')
                    .replace(/\n/g, '<br>')
                    .replace(/^/, '<p class="mb-4">')
                    .replace(/$/, '</p>')
                    .replace(/<p class="mb-4"><\/p>$/, '');
            }

            addStreamingMessage() {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex justify-start';
                const streamingId = 'streaming-' + Date.now();
                messageDiv.id = streamingId;

                messageDiv.innerHTML = `
                    <div class="bg-gray-700 text-white px-6 py-4 rounded-2xl rounded-bl-md max-w-2xl border border-gray-600 shadow-sm">
                        <div class="streaming-content text-sm"></div>
                        <div class="flex items-center space-x-2 mt-2">
                            <div class="w-2 h-2 bg-peach-100 rounded-full loading-dot"></div>
                            <div class="w-2 h-2 bg-peach-100 rounded-full loading-dot"></div>
                            <div class="w-2 h-2 bg-peach-100 rounded-full loading-dot"></div>
                            <span class="text-xs text-gray-400 ml-2">Thinking...</span>
                        </div>
                    </div>
                `;

                this.elements.chatMessages.appendChild(messageDiv);
                this.scrollToBottom();
                return streamingId;
            }

            updateStreamingMessage(streamingId, content) {
                const messageElement = document.getElementById(streamingId);
                if (messageElement) {
                    const contentElement = messageElement.querySelector('.streaming-content');
                    if (contentElement) {
                        contentElement.innerHTML = this.formatMessageContent(content);
                        this.scrollToBottom();
                    }
                }
            }

            finalizeStreamingMessage(streamingId, finalContent, citations = [], sessionId = null) {
                const messageElement = document.getElementById(streamingId);
                if (messageElement) {
                    // Remove loading indicator
                    const loadingElement = messageElement.querySelector('.flex.items-center.space-x-2.mt-2');
                    if (loadingElement) {
                        loadingElement.remove();
                    }

                    // Update with final content
                    const contentElement = messageElement.querySelector('.streaming-content');
                    if (contentElement) {
                        contentElement.innerHTML = this.formatMessageContent(finalContent);
                    }

                    // Add citations if any
                    if (citations && citations.length > 0) {
                        const citationsHTML = `
                            <div class="mt-4 pt-4 border-t border-gray-600">
                                <div class="text-xs font-medium text-gray-400 mb-2">Sources:</div>
                                ${citations.map(citation => `
                                    <div class="bg-gray-600 rounded-lg p-3 mb-2">
                                        <div class="text-xs font-medium text-peach-100 break-all">${this.sanitizeHTML(citation.source)}</div>
                                        <div class="text-xs text-gray-300 mt-1">${this.sanitizeHTML(citation.snippet)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        
                        const bubbleElement = messageElement.querySelector('.bg-gray-700');
                        if (bubbleElement) {
                            bubbleElement.insertAdjacentHTML('beforeend', citationsHTML);
                        }
                    }

                    // Add session debug info if needed
                    if (sessionId) {
                        const sessionDebugInfo = `<div class="text-xs text-gray-500 mt-2">Session: ${sessionId.substring(0, 8)}...</div>`;
                        const bubbleElement = messageElement.querySelector('.bg-gray-700');
                        if (bubbleElement) {
                            bubbleElement.insertAdjacentHTML('beforeend', sessionDebugInfo);
                        }
                    }

                    this.scrollToBottom();
                }
            }

            removeStreamingMessage(streamingId) {
                const messageElement = document.getElementById(streamingId);
                if (messageElement) {
                    messageElement.remove();
                }
            }

            removeLoadingMessage(loadingId) {
                const loadingElement = document.getElementById(loadingId);
                if (loadingElement) {
                    loadingElement.remove();
                }
            }

            sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 p-4 rounded-lg text-white font-medium z-[60] shadow-lg';
                notification.style.animation = 'slideIn 0.3s ease-out';
                
                const colors = {
                    info: 'bg-blue-600',
                    success: 'bg-green-600',
                    warning: 'bg-yellow-600',
                    error: 'bg-red-600'
                };
                notification.classList.add(colors[type] || colors.info);
                notification.textContent = message;

                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        }
    </script>

    <!-- MAIN APPLICATION -->
    <script>
        class LegalAIChat {
            constructor() {
                this.apiClient = new APIClient();
                this.authManager = new AuthManager(this.apiClient);
                this.ui = new UIManager();
                
                this.initialize();
            }

            initialize() {
                this.setupEventListeners();
                this.setupAuthListeners();
                this.checkInitialAuth();
            }

            setupEventListeners() {
                this.ui.elements.chatForm.addEventListener('submit', (e) => this.handleSendMessage(e));
                this.ui.elements.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
            }

            setupAuthListeners() {
                this.authManager.addAuthChangeListener((isAuthenticated, user) => {
                    if (isAuthenticated) {
                        this.ui.hideLogin();
                        this.ui.updateAuthStatus(true, user?.username);
                        this.ui.focusMessageInput();
                        
                        // Show current session info if available
                        const currentSession = this.apiClient.getCurrentSession();
                        if (currentSession) {
                            this.ui.updateSessionInfo(currentSession);
                            console.log('Restored session:', currentSession);
                        } else {
                            this.ui.updateSessionInfo('new', 0);
                        }
                    } else {
                        this.ui.showLogin();
                        this.ui.updateAuthStatus(false);
                    }
                });
            }

            async checkInitialAuth() {
                const isAuthenticated = await this.authManager.checkAuthentication();
                
                if (isAuthenticated) {
                    this.ui.showNotification('Welcome back!', 'success');
                }
            }

            async handleLogin(e) {
                e.preventDefault();
                
                const username = this.ui.elements.usernameInput.value.trim();
                const password = this.ui.elements.passwordInput.value;
                
                if (!username || !password) {
                    this.ui.showLoginError('Please enter both username and password');
                    return;
                }

                try {
                    const result = await this.authManager.login(username, password);
                    
                    if (result.success) {
                        this.ui.showNotification(`Welcome, ${result.user.username}!`, 'success');
                    } else {
                        this.ui.showLoginError(result.error);
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    this.ui.showLoginError('An unexpected error occurred');
                }
            }

            handleLogout() {
                this.authManager.logout();
                this.ui.updateSessionInfo(null, 0);
                this.ui.showNotification('Logged out successfully', 'info');
                
                // Close chat modal if open
                const chatContainer = document.getElementById('mainChatContainer');
                if (!chatContainer.classList.contains('hidden')) {
                    closeMainChat();
                }
            }

            async handleSendMessage(e) {
                e.preventDefault();
                
                if (!this.authManager.isLoggedIn()) {
                    this.ui.showLogin();
                    return;
                }

                const message = this.ui.elements.messageInput.value.trim();
                if (!message) return;

                if (message.length > CONFIG.UI.MAX_MESSAGE_LENGTH) {
                    this.ui.showNotification(`Message too long (max ${CONFIG.UI.MAX_MESSAGE_LENGTH} characters)`, 'warning');
                    return;
                }

                this.ui.clearMessageInput();
                this.ui.setSendButtonState(false);
                this.ui.addMessage('user', message);

                // Create streaming response container
                const streamingMessageId = this.ui.addStreamingMessage();
                let fullResponse = '';
                let currentSessionId = null;

                try {
                    // Use streaming if available, fallback to regular
                    if (this.apiClient.sendMessageStream) {
                        await this.apiClient.sendMessageStream(
                            message,
                            // onChunk
                            (chunk, sessionId) => {
                                fullResponse += chunk;
                                currentSessionId = sessionId;
                                this.ui.updateStreamingMessage(streamingMessageId, fullResponse);
                            },
                            // onComplete  
                            (finalContent, sessionId) => {
                                fullResponse = finalContent;
                                currentSessionId = sessionId;
                                this.ui.finalizeStreamingMessage(streamingMessageId, fullResponse, [], sessionId);
                                
                                // Update session info
                                if (sessionId) {
                                    this.ui.updateSessionInfo(sessionId);
                                    console.log('Streaming completed for session:', sessionId);
                                }
                            },
                            // onError
                            (error) => {
                                this.ui.removeStreamingMessage(streamingMessageId);
                                
                                if (error.status === 401) {
                                    this.authManager.logout();
                                    this.ui.addMessage('assistant', 'Your session has expired. Please log in again.');
                                } else {
                                    this.ui.addMessage('assistant', `I apologize, but I encountered an error: ${error.message}`);
                                }
                                console.error('Streaming error:', error);
                            }
                        );
                    } else {
                        // Fallback to regular non-streaming request
                        const response = await this.apiClient.sendMessage(message);
                        this.ui.removeStreamingMessage(streamingMessageId);
                        this.ui.addMessage('assistant', response.answer, response.citations, response.timestamp, response.session_id);
                        
                        if (response.session_id) {
                            this.ui.updateSessionInfo(response.session_id);
                        }
                    }
                    
                } catch (error) {
                    this.ui.removeStreamingMessage(streamingMessageId);
                    
                    if (error.isAuthError && error.isAuthError()) {
                        this.authManager.logout();
                        this.ui.addMessage('assistant', 'Your session has expired. Please log in again.');
                    } else if (error.isServerError && error.isServerError()) {
                        this.ui.addMessage('assistant', 'I\'m experiencing technical difficulties. Please try again later.');
                    } else {
                        this.ui.addMessage('assistant', `I apologize, but I encountered an error: ${error.message}`);
                    }
                    
                    console.error('Send message error:', error);
                } finally {
                    this.ui.setSendButtonState(true);
                    this.ui.focusMessageInput();
                }
            }

            // Session management methods
            startNewSession() {
                this.apiClient.setCurrentSession(null);
                this.ui.elements.chatMessages.innerHTML = '';
                // Add welcome message back
                this.ui.elements.chatMessages.innerHTML = `
                    <div class="flex justify-start">
                        <div class="bg-gray-700 text-white px-6 py-4 rounded-2xl rounded-bl-md max-w-2xl border border-gray-600 shadow-sm">
                            <p class="mb-2">Hello! I'm your compl.ai Assistant. I specialize in EU regulations, GDPR compliance, CSRD reporting, and regulatory requirements.</p>
                            <p class="mb-2">I can help you navigate complex compliance questions with detailed guidance backed by regulatory sources.</p>
                            <p class="font-medium">How can I assist you with EU compliance today?</p>
                        </div>
                    </div>
                `;
                this.ui.updateSessionInfo('new', 0);
                this.ui.showNotification('New conversation started', 'success');
            }

            sendSampleQuery(query) {
                if (this.authManager.isLoggedIn()) {
                    this.ui.elements.messageInput.value = query;
                    this.ui.elements.chatForm.dispatchEvent(new Event('submit'));
                }
            }

            getCurrentSessionInfo() {
                return {
                    sessionId: this.apiClient.getCurrentSession(),
                    isAuthenticated: this.authManager.isLoggedIn(),
                    user: this.authManager.getCurrentUser()
                };
            }
        }

        // Global functions
        function openMainChat() {
            document.getElementById('mainChatContainer').classList.remove('hidden');
            if (window.legalAI && !window.legalAI.authManager.isLoggedIn()) {
                window.legalAI.ui.showLogin();
            }
        }

        function closeMainChat() {
            document.getElementById('mainChatContainer').classList.add('hidden');
            document.getElementById('loginContainer').classList.add('hidden');
        }

        function sendSampleQuery(query) {
            if (window.legalAI) {
                window.legalAI.sendSampleQuery(query);
            }
        }

        function showLoginModal() {
            if (window.legalAI) {
                window.legalAI.ui.showLogin();
            }
        }

        function handleLogout() {
            if (window.legalAI) {
                window.legalAI.handleLogout();
            }
        }

        function startNewSession() {
            if (window.legalAI) {
                window.legalAI.startNewSession();
            }
        }

        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', () => {
            window.legalAI = new LegalAIChat();
        });
    </script>
</body>
</html>